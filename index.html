<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>YouTube Research Tool - Analisis Video Trending</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            youtube: '#FF0000',
            dark: { bg: '#0f0f23', card: '#1a1a2e', border: '#16213e' }
          }
        }
      }
    }
  </script>
  <style>
    body { box-sizing: border-box; }
    .loading-spinner { border:3px solid #f3f3f3;border-top:3px solid #FF0000;border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
    .card-hover{transition:all .3s ease}
    .card-hover:hover{transform:translateY(-4px);box-shadow:0 20px 25px -5px rgba(0,0,0,.3)}
  </style>
</head>
<body class="h-full bg-dark-bg text-white font-sans">
<div class="min-h-full">
  <!-- Header -->
  <header class="bg-dark-card border-b border-dark-border">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-youtube rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-white">YouTube Research Tool</h1>
            <p class="text-gray-400 text-sm">Analisis video trending & estimasi pendapatan</p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- API Key -->
    <div id="apiKeySection" class="bg-dark-card rounded-xl border border-dark-border p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <svg class="w-5 h-5 text-youtube" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 2 2 0 012 2 1 1 0 102 0 4 4 0 00-4-4z" clip-rule="evenodd"/>
          </svg>
          <h3 class="text-lg font-semibold text-white">YouTube API Key</h3>
          <div id="apiKeyStatus" class="hidden">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-900/50 text-green-300 border border-green-500/50">✓ Tersimpan</span>
          </div>
        </div>
        <button id="toggleApiSection" class="text-gray-400 hover:text-white transition-colors duration-200">
          <svg id="hideIcon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
          </svg>
          <svg id="showIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
      </div>
      <div id="apiKeyContent">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-end">
          <div class="lg:col-span-2">
            <label class="block text-sm font-medium text-gray-300 mb-2">Masukkan YouTube Data API v3 Key Anda</label>
            <input type="password" id="apiKeyInput" placeholder="AIzaSyC-..." class="w-full bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-youtube focus:border-transparent">
            <p class="text-xs text-gray-500 mt-1">API key disimpan lokal di browser Anda dan tidak dikirim ke server manapun</p>
          </div>
          <div>
            <button id="toggleApiKey" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 text-sm">👁️ Tampilkan</button>
          </div>
        </div>
        <div class="mt-4 p-3 bg-blue-900/30 border border-blue-500/50 rounded-lg">
          <div class="flex items-start space-x-2">
            <svg class="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
            </svg>
            <div class="text-xs text-blue-200">
              <strong>Cara mendapatkan API Key:</strong><br>
              1. Buka <a href="https://console.cloud.google.com/" target="_blank" class="text-blue-400 hover:underline">Google Cloud Console</a><br>
              2. Buat project baru → APIs & Services → Library<br>
              3. Cari "YouTube Data API v3" → Enable<br>
              4. Credentials → Create Credentials → API Key
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="bg-dark-card rounded-xl border border-dark-border p-6 mb-6">
      <div class="flex space-x-1 bg-dark-bg rounded-lg p-1">
        <button id="trendingTab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 bg-youtube text-white">🔥 Video Trending</button>
        <button id="channelTab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors duration-200 text-gray-400 hover:text-white">📺 Analisis Channel</button>
      </div>
    </div>

    <!-- Trending Controls -->
    <div id="trendingControls" class="bg-dark-card rounded-xl border border-dark-border p-6 mb-8">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Region</label>
          <select id="regionSelect" class="w-full bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-youtube focus:border-transparent">
            <option value="ID">🇮🇩 Indonesia</option>
            <option value="US">🇺🇸 United States</option>
            <option value="JP">🇯🇵 Japan</option>
            <option value="KR">🇰🇷 South Korea</option>
            <option value="GB">🇬🇧 United Kingdom</option>
            <option value="IN">🇮🇳 India</option>
            <option value="BR">🇧🇷 Brazil</option>
            <option value="DE">🇩🇪 Germany</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Kategori</label>
          <select id="categorySelect" class="w-full bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-youtube focus:border-transparent">
            <option value="">Semua Kategori</option>
            <option value="1">Film & Animation</option><option value="2">Autos & Vehicles</option>
            <option value="10">Music</option><option value="15">Pets & Animals</option>
            <option value="17">Sports</option><option value="19">Travel & Events</option>
            <option value="20">Gaming</option><option value="22">People & Blogs (ASMR, Vlog)</option>
            <option value="23">Comedy</option><option value="24">Entertainment</option>
            <option value="25">News & Politics</option><option value="26">Howto & Style</option>
            <option value="27">Education</option><option value="28">Science & Technology</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Jumlah Video</label>
          <select id="maxResults" class="w-full bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-youtube focus:border-transparent">
            <option value="10">10 Video</option>
            <option value="20" selected>20 Video</option>
            <option value="30">30 Video</option>
            <option value="50">50 Video</option>
          </select>
        </div>
        <div>
          <button id="searchBtn" class="w-full bg-youtube hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 disabled:bg-gray-600 disabled:cursor-not-allowed">
            <span id="searchText">Cari Trending</span>
            <div id="loadingSpinner" class="loading-spinner hidden"></div>
          </button>
        </div>
      </div>
    </div>

    <!-- Channel Controls -->
    <div id="channelControls" class="bg-dark-card rounded-xl border border-dark-border p-6 mb-8 hidden">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-300 mb-2">URL Channel YouTube</label>
          <input type="text" id="channelUrlInput" placeholder="https://www.youtube.com/@channelname atau https://www.youtube.com/channel/UCxxxxx" class="w-full bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-youtube focus:border-transparent">
          <p class="text-xs text-gray-500 mt-1">Masukkan URL channel YouTube (format @username atau channel ID)</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2">Jumlah Video</label>
          <select id="channelMaxResults" class="w-full bg-dark-bg border border-dark-border rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-youtube focus:border-transparent">
            <option value="10">10 Video</option><option value="20" selected>20 Video</option>
            <option value="30">30 Video</option><option value="50">50 Video</option>
          </select>
        </div>
        <div>
          <button id="analyzeChannelBtn" class="w-full bg-youtube hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2 disabled:bg-gray-600 disabled:cursor-not-allowed">
            <span id="analyzeText">Analisis Channel</span>
            <div id="analyzeSpinner" class="loading-spinner hidden"></div>
          </button>
        </div>
      </div>
      <div class="mt-4 p-3 bg-orange-900/30 border border-orange-500/50 rounded-lg">
        <div class="flex items-start space-x-2">
          <svg class="w-4 h-4 text-orange-400 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          <div class="text-xs text-orange-200">
            <strong>Format URL yang didukung:</strong><br>
            • https://www.youtube.com/@channelname<br>
            • https://www.youtube.com/channel/UCxxxxx<br>
            • https://www.youtube.com/c/channelname<br>
            • https://www.youtube.com/user/username
          </div>
        </div>
      </div>
    </div>

    <!-- Status -->
    <div id="statusMessage" class="hidden mb-6">
      <div id="errorMessage" class="bg-red-900/50 border border-red-500 text-red-200 px-4 py-3 rounded-lg hidden">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
          <span id="errorText"></span>
        </div>
      </div>
      <div id="successMessage" class="bg-green-900/50 border border-green-500 text-green-200 px-4 py-3 rounded-lg hidden">
        <div class="flex items-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
          <span id="successText"></span>
        </div>
      </div>
    </div>

    <!-- Channel Info -->
    <div id="channelInfo" class="hidden mb-6">
      <div class="bg-dark-card rounded-xl border border-dark-border p-6">
        <div class="flex items-start space-x-4">
          <img id="channelThumbnail" src="" alt="Channel Avatar" class="w-20 h-20 rounded-full border-2 border-dark-border">
          <div class="flex-1">
            <h3 id="channelTitle" class="text-xl font-bold text-white mb-2"></h3>
            <p id="channelDescription" class="text-gray-400 text-sm mb-4 line-clamp-3"></p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center"><div id="channelSubscribers" class="text-lg font-bold text-youtube">-</div><div class="text-xs text-gray-500">Subscribers</div></div>
              <div class="text-center"><div id="channelViews" class="text-lg font-bold text-green-400">-</div><div class="text-xs text-gray-500">Total Views</div></div>
              <div class="text-center"><div id="channelVideos" class="text-lg font-bold text-blue-400">-</div><div class="text-xs text-gray-500">Videos</div></div>
              <div class="text-center"><div id="channelCreated" class="text-lg font-bold text-purple-400">-</div><div class="text-xs text-gray-500">Created</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsContainer" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-semibold text-white">Video Trending</h2>
        <div class="text-sm text-gray-400"><span id="resultsCount">0</span> video ditemukan</div>
      </div>
      <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </div>

    <!-- Empty -->
    <div id="emptyState" class="text-center py-16">
      <div class="w-24 h-24 bg-dark-card rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-12 h-12 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-300 mb-2">Belum ada data</h3>
      <p class="text-gray-500 mb-6">Masukkan API key dan pilih region untuk melihat video trending</p>
    </div>
  </main>
</div>

<!-- Video Popup Modal -->
<div id="videoPopup" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
  <div class="relative w-full max-w-4xl bg-dark-card rounded-xl overflow-hidden">
    <button onclick="closeVideoPopup()" class="absolute top-4 right-4 z-10 bg-black bg-opacity-50 hover:bg-opacity-75 text-white rounded-full p-2 transition-all duration-200">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
    <div class="relative w-full" style="padding-bottom:56.25%;height:0;">
      <iframe id="youtubeIframe"
              class="absolute top-0 left-0 w-full h-full"
              src=""
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              referrerpolicy="strict-origin-when-cross-origin">
      </iframe>
    </div>
  </div>
</div>

<script>
  // ====== DOM ======
  const searchBtn = document.getElementById('searchBtn');
  const searchText = document.getElementById('searchText');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const regionSelect = document.getElementById('regionSelect');
  const categorySelect = document.getElementById('categorySelect');
  const maxResults = document.getElementById('maxResults');
  const apiKeyInput = document.getElementById('apiKeyInput');
  const toggleApiKey = document.getElementById('toggleApiKey');
  const toggleApiSection = document.getElementById('toggleApiSection');
  const apiKeyContent = document.getElementById('apiKeyContent');
  const apiKeyStatus = document.getElementById('apiKeyStatus');
  const hideIcon = document.getElementById('hideIcon');
  const showIcon = document.getElementById('showIcon');
  const statusMessage = document.getElementById('statusMessage');
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  const errorText = document.getElementById('errorText');
  const successText = document.getElementById('successText');
  const resultsContainer = document.getElementById('resultsContainer');
  const videoGrid = document.getElementById('videoGrid');
  const emptyState = document.getElementById('emptyState');
  const resultsCount = document.getElementById('resultsCount');

  const trendingTab = document.getElementById('trendingTab');
  const channelTab = document.getElementById('channelTab');
  const trendingControls = document.getElementById('trendingControls');
  const channelControls = document.getElementById('channelControls');

  const channelUrlInput = document.getElementById('channelUrlInput');
  const channelMaxResults = document.getElementById('channelMaxResults');
  const analyzeChannelBtn = document.getElementById('analyzeChannelBtn');
  const analyzeText = document.getElementById('analyzeText');
  const analyzeSpinner = document.getElementById('analyzeSpinner');
  const channelInfo = document.getElementById('channelInfo');
  const channelThumbnail = document.getElementById('channelThumbnail');
  const channelTitle = document.getElementById('channelTitle');
  const channelDescription = document.getElementById('channelDescription');
  const channelSubscribers = document.getElementById('channelSubscribers');
  const channelViews = document.getElementById('channelViews');
  const channelVideos = document.getElementById('channelVideos');
  const channelCreated = document.getElementById('channelCreated');

  const API_KEY_STORAGE = 'youtube_api_key';
  let currentMode = 'trending';

  // ====== Utils ======
  function formatNumber(num) {
    const n = Number(num) || 0;
    if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
    if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
    return String(n);
  }
  function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(amount||0);
  }
  function formatDate(dateString) {
    const date = new Date(dateString), now = new Date();
    const diffDays = Math.ceil(Math.abs(now - date)/86400000);
    if (diffDays===1) return '1 hari lalu';
    if (diffDays<7) return `${diffDays} hari lalu`;
    if (diffDays<30) return `${Math.floor(diffDays/7)} minggu lalu`;
    return `${Math.floor(diffDays/30)} bulan lalu`;
  }
  function formatFullDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('id-ID',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',timeZone:'Asia/Jakarta'});
  }
  function formatYearOnly(dateString){ return new Date(dateString).getFullYear().toString(); }

  function extractChannelId(url) {
    const patterns = [
      /youtube\.com\/channel\/([a-zA-Z0-9_-]+)/,
      /youtube\.com\/@([a-zA-Z0-9_.-]+)/,
      /youtube\.com\/c\/([a-zA-Z0-9_.-]+)/,
      /youtube\.com\/user\/([a-zA-Z0-9_.-]+)/
    ];
    for (const p of patterns) { const m = url.match(p); if (m) return {type: p.source.includes('channel')?'id':'username', value:m[1]}; }
    return null;
  }

  function switchTab(mode){
    currentMode = mode;
    if(mode==='trending'){
      trendingTab.classList.add('bg-youtube','text-white'); trendingTab.classList.remove('text-gray-400');
      channelTab.classList.remove('bg-youtube','text-white'); channelTab.classList.add('text-gray-400');
      trendingControls.classList.remove('hidden'); channelControls.classList.add('hidden'); channelInfo.classList.add('hidden');
    } else {
      channelTab.classList.add('bg-youtube','text-white'); channelTab.classList.remove('text-gray-400');
      trendingTab.classList.remove('bg-youtube','text-white'); trendingTab.classList.add('text-gray-400');
      channelControls.classList.remove('hidden'); trendingControls.classList.add('hidden'); resultsContainer.classList.add('hidden'); emptyState.classList.remove('hidden');
    }
  }

  function extractKeywords(title, description=''){
    const text=(title+' '+description).toLowerCase();
    const stop=['the','and','or','but','in','on','at','to','for','of','with','by','yang','dan','di','ke','dari','untuk','dengan','ini','itu','adalah','akan','sudah','telah','bisa','dapat','tidak','jangan','harus','mau','ingin','saya','kamu','dia','kita','mereka','kami'];
    const words=text.match(/\b\w{3,}\b/g)||[];
    const filtered=words.filter(w=>!stop.includes(w));
    const count={}; filtered.forEach(w=>count[w]=(count[w]||0)+1);
    return Object.entries(count).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([w])=>w);
  }

  function showMessage(type, msg){
    statusMessage.classList.remove('hidden');
    if(type==='error'){ errorMessage.classList.remove('hidden'); successMessage.classList.add('hidden'); errorText.textContent=msg; }
    else { successMessage.classList.remove('hidden'); errorMessage.classList.add('hidden'); successText.textContent=msg; }
    setTimeout(()=>statusMessage.classList.add('hidden'),5000);
  }

  function setLoading(b){ searchBtn.disabled=b; searchText.textContent=b?'Mencari...':'Cari Trending'; loadingSpinner.classList.toggle('hidden',!b); }
  function setChannelLoading(b){ analyzeChannelBtn.disabled=b; analyzeText.textContent=b?'Menganalisis...':'Analisis Channel'; analyzeSpinner.classList.toggle('hidden',!b); }

  function saveApiKey(k){ localStorage.setItem(API_KEY_STORAGE,k); }
  function loadApiKey(){ return localStorage.getItem(API_KEY_STORAGE)||''; }
  function validateApiKey(k){ return k && k.trim().length>20 && k.startsWith('AIza'); }
  function updateApiKeyStatus(){
    const k=apiKeyInput.value.trim();
    apiKeyStatus.classList.toggle('hidden',!validateApiKey(k));
    if(validateApiKey(k)) setTimeout(()=>{ if(validateApiKey(apiKeyInput.value.trim())) hideApiKeySection(); },1000);
  }
  function hideApiKeySection(){ apiKeyContent.classList.add('hidden'); hideIcon.classList.add('hidden'); showIcon.classList.remove('hidden'); }
  function showApiKeySection(){ apiKeyContent.classList.remove('hidden'); hideIcon.classList.remove('hidden'); showIcon.classList.add('hidden'); }

  function calculateRPM(video){
    const categoryId = video?.snippet?.categoryId;
    const views = parseInt(video?.statistics?.viewCount||'0',10);
    const region = regionSelect.value;
    const categoryRPM = {'1':0.8,'2':1.2,'10':0.3,'15':0.7,'17':1.1,'19':0.9,'20':1.8,'22':0.9,'23':0.8,'24':0.7,'25':2.1,'26':1.4,'27':1.6,'28':2.3};
    let base = categoryRPM[categoryId] || 1.0;
    const regionMul={'US':1,'GB':0.85,'DE':0.8,'JP':0.75,'KR':0.6,'BR':0.4,'IN':0.25,'ID':0.2};
    base *= (regionMul[region] || 0.5);
    if (views>5e7) base*=1.15; else if (views>1e7) base*=1.1; else if (views>1e6) base*=1.05;
    return Math.round(base*100)/100;
  }

  function getVideoId(video){
    // videos.list -> id is string; search.list -> id is object { videoId }
    if (typeof video.id === 'string') return video.id;
    if (video.id && video.id.videoId) return video.id.videoId;
    return '';
  }

  // === Embeddable guard ===
  function isEmbeddable(video, regionCode){
    const status = video.status || {};
    const rating = video.contentRating || {};
    const details = video.contentDetails || {};
    if (!status.embeddable) return false;
    if (rating.ytRating === 'ytAgeRestricted') return false;
    const rr = details.regionRestriction || {};
    if (rr.blocked && regionCode && rr.blocked.includes(regionCode)) return false;
    if (rr.allowed && regionCode && !rr.allowed.includes(regionCode)) return false;
    return true;
  }

  function createVideoCard(video, index, isChannelMode=false){
    const videoId = getVideoId(video);
    const views = parseInt(video?.statistics?.viewCount||'0',10);
    const rpm = calculateRPM(video);
    const estimatedEarnings = (views/1000)*rpm;
    const keywords = extractKeywords(video?.snippet?.title||'', video?.snippet?.description||'');
    const canEmbed = !!(video?.status?.embeddable && video?.contentRating?.ytRating !== 'ytAgeRestricted');

    return `
      <div class="bg-dark-card border border-dark-border rounded-xl overflow-hidden card-hover">
        <div class="relative">
          <img src="${video?.snippet?.thumbnails?.medium?.url||''}" alt="${video?.snippet?.title||''}" class="w-full h-48 object-cover" onerror="this.src='';this.alt='Thumbnail gagal dimuat';this.style.display='none';">
          <div class="absolute top-2 left-2 ${isChannelMode?'bg-blue-600':'bg-youtube'} text-white text-xs font-bold px-2 py-1 rounded">${isChannelMode?`Video ${index+1}`:`#${index+1}`}</div>
          <div class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded">${formatDate(video?.snippet?.publishedAt)}</div>
        </div>
        <div class="p-4">
          <h3 class="font-semibold text-white text-sm mb-2 line-clamp-2 leading-tight">${video?.snippet?.title||''}</h3>
          <p class="text-gray-400 text-xs mb-3 truncate">${video?.snippet?.channelTitle||''}</p>

          <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-2 mb-3">
            <div class="flex items-center space-x-1">
              <svg class="w-3 h-3 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>
              <span class="text-blue-300 text-xs font-medium">Upload:</span>
            </div>
            <p class="text-blue-200 text-xs mt-1">${formatFullDate(video?.snippet?.publishedAt)}</p>
          </div>

          <div class="mb-3">
            <div class="flex items-center space-x-1 mb-2">
              <svg class="w-3 h-3 text-purple-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.243 3.03a1 1 0 01.727 1.213L9.53 6h2.94l.56-2.243a1 1 0 111.94.486L14.53 6H17a1 1 0 110 2h-2.97l-1 4H15a1 1 0 110 2h-2.47l-.56 2.242a1 1 0 11-1.94-.485L10.47 14H7.53l-.56 2.242a1 1 0 11-1.94-.485L5.47 14H3a1 1 0 110-2h2.97l1-4H5a1 1 0 110-2h2.47l.56-2.243a1 1 0 011.213-.727zM9.03 8l-1 4h2.94l1-4H9.03z" clip-rule="evenodd"/></svg>
              <span class="text-purple-300 text-xs font-medium">Keywords:</span>
            </div>
            <div class="flex flex-wrap gap-1">
              ${keywords.map(k=>`<span class="bg-purple-900/40 text-purple-200 text-xs px-2 py-1 rounded-full border border-purple-500/30">${k}</span>`).join('')}
            </div>
          </div>

          <div class="space-y-2 mb-4">
            <div class="flex justify-between items-center"><span class="text-gray-400 text-xs">Views:</span><span class="text-white font-medium text-sm">${formatNumber(views)}</span></div>
            <div class="flex justify-between items-center"><span class="text-gray-400 text-xs">RPM:</span><span class="text-white font-medium text-sm">$${rpm}</span></div>
          </div>

          <div class="bg-green-900/30 border border-green-500/50 rounded-lg p-3 mb-4">
            <div class="text-center">
              <div class="text-green-400 text-xs font-medium mb-1">Estimasi Pendapatan</div>
              <div class="text-green-300 text-lg font-bold">${formatCurrency(estimatedEarnings)}</div>
            </div>
          </div>

          <button onclick="openYouTubeVideo('${videoId}', ${canEmbed})"
                  class="block w-full bg-youtube hover:bg-red-700 text-white text-center py-2 px-4 rounded-lg transition-colors duration-200 text-sm font-medium cursor-pointer">
            ▶️ Tonton Video
          </button>
          <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" rel="noopener"
             class="mt-2 block w-full text-center py-2 px-4 rounded-lg border border-dark-border hover:bg-dark-bg/60 transition-colors duration-200 text-sm">
            🔗 Buka di YouTube
          </a>
        </div>
      </div>
    `;
  }

  function displayResults(videos, isChannelMode=false){
    if(!videos||!videos.length){ emptyState.classList.remove('hidden'); resultsContainer.classList.add('hidden'); return; }
    emptyState.classList.add('hidden'); resultsContainer.classList.remove('hidden'); resultsCount.textContent=videos.length;
    document.querySelector('#resultsContainer h2').textContent = isChannelMode?'Video Channel':'Video Trending';
    videoGrid.innerHTML = videos.map((v,i)=>createVideoCard(v,i,isChannelMode)).join('');
  }

  function openYouTubeVideo(videoId, canEmbed=true){
    if(!videoId){ return; }
    if(!canEmbed){
      window.open(`https://www.youtube.com/watch?v=${videoId}`,'_blank','noopener'); return;
    }
    const popup=document.getElementById('videoPopup');
    const iframe=document.getElementById('youtubeIframe');
    const origin=encodeURIComponent(location.origin);
    iframe.src=`https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1&playsinline=1&origin=${origin}`;
    popup.classList.remove('hidden'); popup.classList.add('flex'); document.body.style.overflow='hidden';
  }
  function closeVideoPopup(){
    const popup=document.getElementById('videoPopup');
    const iframe=document.getElementById('youtubeIframe');
    popup.classList.add('hidden'); popup.classList.remove('flex'); iframe.src=''; document.body.style.overflow='auto';
  }

  // ====== API Calls ======
  async function getChannelIdFromUsername(username, apiKey){
    try{
      const r = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=id&forUsername=${encodeURIComponent(username)}&key=${apiKey}`);
      const d = await r.json();
      if(d.items && d.items.length>0) return d.items[0].id;
      const s = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${encodeURIComponent(username)}&key=${apiKey}`);
      const sd = await s.json();
      if(sd.items && sd.items.length>0) return sd.items[0].snippet.channelId;
      return null;
    }catch(e){ console.error(e); return null; }
  }

  async function analyzeChannel(){
    const apiKey = apiKeyInput.value.trim();
    const channelUrl = channelUrlInput.value.trim();
    const maxChannelResults = parseInt(channelMaxResults.value,10);
    if(!validateApiKey(apiKey)){ showMessage('error','API Key tidak valid.'); return; }
    if(!channelUrl){ showMessage('error','Masukkan URL channel YouTube terlebih dahulu.'); return; }
    const channelData = extractChannelId(channelUrl);
    if(!channelData){ showMessage('error','Format URL channel tidak valid.'); return; }

    setChannelLoading(true);
    try{
      let channelId = channelData.value;
      if(channelData.type==='username'){
        channelId = await getChannelIdFromUsername(channelData.value, apiKey);
        if(!channelId) throw new Error('Channel tidak ditemukan. Periksa URL.');
      }

      const ch = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${apiKey}`);
      if(!ch.ok){ const ed=await ch.json(); throw new Error(ed.error?.message || `HTTP ${ch.status}`); }
      const chInfo = await ch.json();
      if(!chInfo.items||!chInfo.items.length) throw new Error('Channel tidak ditemukan.');

      const list = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&type=video&order=date&maxResults=${maxChannelResults}&key=${apiKey}`);
      if(!list.ok){ const ed=await list.json(); throw new Error(ed.error?.message || `HTTP ${list.status}`); }
      const listData = await list.json();
      if(!listData.items||!listData.items.length) throw new Error('Tidak ada video ditemukan di channel ini.');

      const videoIds = listData.items.map(it=>it.id.videoId).filter(Boolean).join(',');
      const stats = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails,status,player&id=${videoIds}&key=${apiKey}`);
      const statsData = await stats.json();

      const embeddableItems = (statsData.items||[]).filter(v=>isEmbeddable(v,null));
      if(!embeddableItems.length) throw new Error('Video channel ini tidak ada yang mengizinkan embed / dibatasi.');

      displayChannelInfo(chInfo.items[0]);
      displayResults(embeddableItems,true);
      showMessage('success',`Berhasil menganalisis channel dengan ${embeddableItems.length} video yang dapat di-embed`);
    }catch(err){
      console.error(err);
      let m = err.message||'Error';
      if(m.includes('API_KEY_INVALID')) m='API Key tidak valid.';
      else if(m.includes('QUOTA_EXCEEDED')) m='Kuota API habis.';
      else if(m.includes('ACCESS_NOT_CONFIGURED')) m='YouTube Data API v3 belum diaktifkan.';
      showMessage('error',`Gagal menganalisis channel: ${m}`);
      channelInfo.classList.add('hidden'); emptyState.classList.remove('hidden'); resultsContainer.classList.add('hidden');
    }finally{ setChannelLoading(false); }
  }

  function displayChannelInfo(channel){
    const stats=channel.statistics||{}, sn=channel.snippet||{};
    channelThumbnail.src = sn.thumbnails?.medium?.url || sn.thumbnails?.default?.url || '';
    channelThumbnail.onerror=function(){ this.src=''; this.alt='Avatar gagal dimuat'; this.style.display='none'; };
    channelTitle.textContent = sn.title||'-';
    channelDescription.textContent = sn.description || 'Tidak ada deskripsi';
    channelSubscribers.textContent = formatNumber(parseInt(stats.subscriberCount||0,10));
    channelViews.textContent = formatNumber(parseInt(stats.viewCount||0,10));
    channelVideos.textContent = formatNumber(parseInt(stats.videoCount||0,10));
    channelCreated.textContent = formatYearOnly(sn.publishedAt||new Date().toISOString());
    channelInfo.classList.remove('hidden');
  }

  async function fetchTrendingVideos(){
    const apiKey = apiKeyInput.value.trim();
    const region = regionSelect.value;
    const category = categorySelect.value;
    const max = parseInt(maxResults.value,10);
    if(!validateApiKey(apiKey)){ showMessage('error','API Key tidak valid.'); return; }
    saveApiKey(apiKey);
    setLoading(true);
    try{
      let url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails,status,player&chart=mostPopular&regionCode=${region}&maxResults=${max}&key=${apiKey}`;
      if(category) url += `&videoCategoryId=${category}`;
      const r = await fetch(url);
      if(!r.ok){ const ed=await r.json(); throw new Error(ed.error?.message || `HTTP ${r.status}: ${r.statusText}`); }
      const data = await r.json();
      if(!data.items || !data.items.length) throw new Error('Tidak ada video trending untuk region ini.');

      const embeddableItems = data.items.filter(v=>isEmbeddable(v, region));
      if(!embeddableItems.length) throw new Error('Semua video trending saat ini diblokir untuk embed / dibatasi. Coba region/kategori lain.');

      displayResults(embeddableItems,false);
      showMessage('success', embeddableItems.length < data.items.length
        ? `Berhasil memuat ${embeddableItems.length}/${data.items.length} video (sebagian diblokir untuk embed).`
        : `Berhasil memuat ${embeddableItems.length} video trending dari ${region}`);
    }catch(err){
      console.error(err);
      let m = err.message||'Error';
      if(m.includes('API_KEY_INVALID')) m='API Key tidak valid.';
      else if(m.includes('QUOTA_EXCEEDED')) m='Kuota API sudah habis.';
      else if(m.includes('ACCESS_NOT_CONFIGURED')) m='YouTube Data API v3 belum diaktifkan.';
      showMessage('error',`Gagal memuat data: ${m}`);
      emptyState.classList.remove('hidden'); resultsContainer.classList.add('hidden');
    }finally{ setLoading(false); }
  }

  // ====== Events ======
  searchBtn.addEventListener('click', fetchTrendingVideos);
  analyzeChannelBtn.addEventListener('click', analyzeChannel);
  trendingTab.addEventListener('click',()=>switchTab('trending'));
  channelTab.addEventListener('click',()=>switchTab('channel'));

  toggleApiKey.addEventListener('click',()=>{
    if(apiKeyInput.type==='password'){ apiKeyInput.type='text'; toggleApiKey.textContent='🙈 Sembunyikan'; }
    else { apiKeyInput.type='password'; toggleApiKey.textContent='👁️ Tampilkan'; }
  });
  toggleApiSection.addEventListener('click',()=>{ apiKeyContent.classList.contains('hidden')?showApiKeySection():hideApiKeySection(); });

  apiKeyInput.addEventListener('input',()=>{
    const k=apiKeyInput.value.trim(); if(k) saveApiKey(k); updateApiKeyStatus();
  });

  [regionSelect,categorySelect,maxResults,apiKeyInput].forEach(el=>{
    el.addEventListener('keypress',e=>{ if(e.key==='Enter' && currentMode==='trending') fetchTrendingVideos(); });
  });
  [channelUrlInput,channelMaxResults].forEach(el=>{
    el.addEventListener('keypress',e=>{ if(e.key==='Enter') analyzeChannel(); });
  });

  document.getElementById('videoPopup').addEventListener('click',e=>{ if(e.target.id==='videoPopup') closeVideoPopup(); });
  document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ const p=document.getElementById('videoPopup'); if(!p.classList.contains('hidden')) closeVideoPopup(); } });

  document.addEventListener('DOMContentLoaded',()=>{
    const saved=loadApiKey(); if(saved){ apiKeyInput.value=saved; updateApiKeyStatus(); }
  });
</script>

<!-- Catatan: Script Cloudflare challenge telah DIHAPUS untuk mencegah gangguan pada iframe YouTube. -->
</body>
</html>
